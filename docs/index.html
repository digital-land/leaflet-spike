<head>
  <style>
    #mapid { height: 80%; }
    .deactivated-control { color: #b1b4b6; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
  <link href="https://digital-land.github.io/stylesheets/dl-frontend.css" rel="stylesheet" />
</head>
<body>

  <!-- Make sure you put this AFTER Leaflet's CSS -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
  <script src="./leaflet.permalink.min.js"></script>

  <div id="control"><button onclick="showLayers()">Show Layers</button></div>

  <div class="dl-map__wrapper">
    <div id="mapid"></div>
    <div class="dl-map__side-panel">
      <div class="dl-map__side-panel__section">
        <h3 class="govuk-heading-s govuk-!-margin-bottom-0">Data layers</h3>
      </div>
      <div class="dl-map__side-panel__section">
        <ul class="govuk-list" data-module="layer-controls">
          <li data-layer-control="local-authority-district" data-layer-control-active="true">Local authority districts</li>
          <li data-layer-control="conservation-area" data-layer-control-active="true">Conservation areas</li>
          <li data-layer-control="brownfield-land" data-layer-control-active="true">Brownfield land</li>
        </ul>
      </div>
    </div>
  </div>
  
    <script src="layer-controls.js"></script>
    <script>
      // callback used when layer control is clicked
      function toggleLayer(map, datasetName, add) {
        const layer = layerMap[datasetName]
        if (add) {
          if (map._fetchSinceControlAction) {
            // if something has changed since layer last shown then trigger fetch all
            // can further improve by fetching only reenable layer
            fetchAll()
          }
          map.addLayer(layer)
        } else {
          map.removeLayer(layer)
        }
      }

      var mappos = L.Permalink.getMapLocation();
      console.log(mappos)
      var theMap = L.map('mapid', {
        center: mappos.center,
        zoom: mappos.zoom
      });
      L.Permalink.setup(theMap);

      <!-- var theMap = L.map('mapid').setView([51.505, -0.09], 8); -->

      const $controlsList = document.querySelector('[data-module="layer-controls"]')
      const layerControlsComponent = new LayerControls($controlsList, theMap).init({
        toggleControlCallback: toggleLayer
      })

      var baseUrl = "https://datasette-demo.digital-land.info/view_model"
      <!-- baseUrl = "http://localhost:8091/view_model" -->

      var dlBaseUrl = "http://digital-land.github.io"

      var pageSize = 100

      // add the OpenStreetMap tiles
      L.tileLayer('https://tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
      }).addTo(theMap);

      function fetchFeatures(progress, url, geoJsonLayer) {
        console.debug("fetchFeatures", url.href)
        return new Promise((resolve, reject) => fetch(url)
          .then(response => {
              if (response.status !== 200)  {
                throw `${response.status}: ${response.statusText}`;
              }
              response.json().then(data => { 
                geoJsonLayer.addData(data)

                if(data.length >= pageSize) {
                  progress && progress(geoJsonLayer);
                  lastItem = data[data.length - 1]
                  let nextUrl = url
                  nextUrl.searchParams.set("after", lastItem.id)
                  console.log(nextUrl.href)
                  fetchFeatures(progress, nextUrl, geoJsonLayer).then(resolve).catch(reject)
                } else {
                  resolve(geoJsonLayer);
                }
              }).catch(reject);
          }).catch(reject));
        }

        function progressCallback(geoJsonLayer) {
          console.debug(`${geoJsonLayer.getLayers().length} features fetched`);
        }

        function buildUrl(bounds, zoomLevel, type=false, after_rowid=0) {
          var query = "bounded_geography_simplified_paged"
          if (zoomLevel > 11) {query = "bounded_geography_full_paged"}
          if (type) {query = `${query}_by_type`}

          url = new URL(`${baseUrl}/${query}.json?_json=geojson&_shape=arrayfirst&bbox_minx=${bounds._southWest.lng}&bbox_maxx=${bounds._northEast.lng}&bbox_miny=${bounds._southWest.lat}&bbox_maxy=${bounds._northEast.lat}&after=${after_rowid}`)

          if (type) url.searchParams.set("type", type)

          return url
        }

        var geoJsonLayerOptions = {
          style: function(feature) {
            switch (feature.properties.type) {
              case 'local-authority-district': return {color: "#EE7800", weight: 2};
              case 'conservation-area': return {color: "#78AA00", weight: 2};
              case 'brownfield-land': return {color: "#0078ff", weight: 2};
            }
          },
          onEachFeature: onEachFeature,
        }

        var geojsonLocalAuthorityDistrict = L.geoJSON(false, geoJsonLayerOptions).addTo(theMap)
        var geojsonConservationArea = L.geoJSON(false, geoJsonLayerOptions).addTo(theMap)
        var geojsonBrownfieldLand = L.geoJSON(false, geoJsonLayerOptions).addTo(theMap)

        var layerMap = {
          "local-authority-district": geojsonLocalAuthorityDistrict,
          "conservation-area": geojsonConservationArea,
          "brownfield-land": geojsonBrownfieldLand,
        }

        function onEachFeature(feature, layer) {
          if (feature.properties) {
            layer.bindPopup(`
              <h3>${feature.properties.name}</h3>
              ${feature.properties.type}<br>
              <a href=${dlBaseUrl}${feature.properties.slug}>${feature.properties.slug}</a>
            `);
          }
        }

        function fetchAll(bounds=theMap.getBounds()) {
          for (const [key, value] of Object.entries(layerMap)) {
            value.clearLayers()
          }
          layerControlsComponent.activeLayers().forEach(layer => {
            let type_ = layer.dataset.layerControl
            console.log("fetching", type_)
            fetchFeatures(progressCallback, buildUrl(bounds, theMap.getZoom(), type_), layerMap[type_]).then(function (geoJsonLayer) {
              console.log("fetch complete", type_)
              theMap._fetchSinceControlAction = true
            }).catch(
              console.error
            )
          })
        }

        theMap.on('moveend', function(event){
          var bounds = event.target.getBounds()
          fetchAll(bounds)
        });

        fetchAll()

    </script>
  </div>
</body>
