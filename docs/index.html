<head>
  <style>
    #mapid { height: 80%; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
</head>
<body>

  <!-- Make sure you put this AFTER Leaflet's CSS -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>

  <div id="control"><button onclick="showLayers()">Show Layers</button></div>
  <div id="mapid"></div>
    <script>
      var theMap = L.map('mapid').setView([51.505, -0.09], 8);

      var baseUrl = "https://datasette-demo.digital-land.info/view_model"
      <!-- baseUrl = "http://localhost:8091/view_model" -->

      var dlBaseUrl = "http://digital-land.github.io"

      var pageSize = 100

      // add the OpenStreetMap tiles
      L.tileLayer('https://tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
      }).addTo(theMap);

      function fetchFeatures(progress, url, geoJsonLayer) {
        console.log("fetchFeatures", url.href)
        return new Promise((resolve, reject) => fetch(url)
          .then(response => {
              if (response.status !== 200)  {
                throw `${response.status}: ${response.statusText}`;
              }
              response.json().then(data => { 
                geoJsonLayer.addData(data)

                if(data.length >= pageSize && firstLoad) {
                  progress && progress(geoJsonLayer);
                  lastItem = data[data.length - 1]
                  let nextUrl = url
                  nextUrl.searchParams.set("after", lastItem.id)
                  console.log(nextUrl.href)
                  fetchFeatures(progress, nextUrl, geoJsonLayer).then(resolve).catch(reject)
                } else {
                  resolve(geoJsonLayer);
                }
              }).catch(reject);
          }).catch(reject));
        }

        function progressCallback(geoJsonLayer) {
          console.log(`${geoJsonLayer.getLayers().length} features fetched`);
        }

        function buildUrl(bounds, zoomLevel, type=false, after_rowid=0) {
          var query = "bounded_geography_simplified_paged"
          if (zoomLevel > 11) {query = "bounded_geography_full_paged"}
          if (type) {query = `${query}_by_type`}

          url = new URL(`${baseUrl}/${query}.json?_json=geojson&_shape=arrayfirst&bbox_minx=${bounds._southWest.lng}&bbox_maxx=${bounds._northEast.lng}&bbox_miny=${bounds._southWest.lat}&bbox_maxy=${bounds._northEast.lat}&after=${after_rowid}`)

          if (type) url.searchParams.set("type", type)

          return url
        }

        var geoJsonLayerOptions = {
          style: function(feature) {
            switch (feature.properties.type) {
              case 'local-authority-district': return {color: "#EE7800", weight: 2};
              case 'conservation-area': return {color: "#78AA00", weight: 2};
              case 'brownfield-land': return {color: "#0078ff", weight: 2};
            }
          },
          onEachFeature: onEachFeature,
        }

        var geojsonConservationArea = L.geoJSON(false, geoJsonLayerOptions).addTo(theMap)
        var geojsonLocalAreaDistrict = L.geoJSON(false, geoJsonLayerOptions).addTo(theMap)
        var geojsonBrownfieldLand = L.geoJSON(false, geoJsonLayerOptions).addTo(theMap)

        function onEachFeature(feature, layer) {
          if (feature.properties) {
            layer.bindPopup(`
              <h3>${feature.properties.name}</h3>
              ${feature.properties.type}<br>
              <a href=${dlBaseUrl}${feature.properties.slug}>${feature.properties.slug}</a>
            `);
          }
        }

        function showLayers() {
          let i = 0;
          theMap.eachLayer(function(layer) {i += 1})
          console.log("layer count", i)
        }

        var firstLoad = true

        theMap.on('moveend', function(event){
          var bounds = event.target.getBounds()
          geojsonLocalAreaDistrict.clearLayers()
          fetchFeatures(progressCallback, buildUrl(bounds, theMap.getZoom()), geojsonLocalAreaDistrict).then(
            geoJsonLayer => {console.log("fetch complete")}
          ).catch(
            console.error
          )
        });

        var bounds = theMap.getBounds()
        fetchFeatures(progressCallback, buildUrl(bounds), geojsonLocalAreaDistrict).then(
          geoJsonLayer => {console.log("fetch complete")}
        ).catch(
          console.error
        );

    </script>
  </div>
</body>
