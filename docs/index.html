<head>
  <style>
    #mapid { height: 100%; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
</head>
<body>

  <!-- Make sure you put this AFTER Leaflet's CSS -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>

  <!-- leaflet.ajax allows loading geoJSON directly via AJAX -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>

  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-vector-layers/1.6.0/lvector.min.js"></script> -->

  <div id="mapid"></div>
    <script>
      var mymap = L.map('mapid').setView([51.505, -0.09], 8);

      // add the OpenStreetMap tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
      }).addTo(mymap);

      var myLayer = L.geoJSON().addTo(mymap);

      function fetchFeatures(bbox_minx, bbox_maxx, bbox_miny, bbox_maxy) {
        console.log("fetching features for area: ", bbox_minx, bbox_maxx, bbox_miny, bbox_maxy)
        var geojson = new L.GeoJSON.AJAX(`https://datasette-demo.digital-land.info/view_model/bounded_geography_simplified.json?_json=geometry&_shape=array&bbox_minx=${bbox_minx}&bbox_maxx=${bbox_maxx}&bbox_miny=${bbox_miny}&bbox_maxy=${bbox_maxy}`, {
          middleware:function(data) {
            console.log("middleware!")
            console.log(data)
            return data.map(myFunction)
          }
        })
        geojson.on('data:loaded', function() {
          console.log("DATA LOADED", geojson)
          <!-- myLayer.addData(geojson) -->
          myLayer.clearLayers()
          geojson.addTo(myLayer)
        })
      }

      mymap.on('moveend', function(event){
        console.log("moveend")
        console.log(event.target.getBounds())
        var bounds = event.target.getBounds()
        fetchFeatures(bounds._southWest.lng, bounds._northEast.lng, bounds._southWest.lat, bounds._northEast.lat)
      });

      function myFunction(value, index, array) {
        return value.geometry;
      }


      <!-- geojson.on('data:loaded', function(){ -->
      <!--   console.log("finished") -->
      <!--   console.log(geojson) -->
      <!--   <!-1- geojson.addTo(mymap); -1-> -->
      <!-- }); -->
    </script>
  </div>
</body>
