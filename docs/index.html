<head>
  <style>
    #mapid { height: 80%; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
</head>
<body>

  <!-- Make sure you put this AFTER Leaflet's CSS -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>

  <!-- leaflet.ajax allows loading geoJSON directly via AJAX -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>

  <div id="control"><button onclick="showLayers()">Show Layers</button></div>

  <div id="mapid"></div>
    <script>
      var mymap = L.map('mapid').setView([51.505, -0.09], 8);

      // add the OpenStreetMap tiles
      L.tileLayer('https://tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
      }).addTo(mymap);

      var myLayer = L.geoJSON().addTo(mymap);

      function onEachFeature(feature, layer) {
        <!-- console.log("onEachFeature", feature) -->
        if (feature.properties) {
          layer.bindPopup(`
            <h3>${feature.properties.name}</h3>
            ${feature.properties.type}<br>
            <a href=${dlBaseUrl}${feature.properties.slug}>${feature.properties.slug}</a>
          `);
        }
      }

      var baseUrl = "https://datasette-demo.digital-land.info/view_model"
      <!-- baseUrl = "http://localhost:8091/view_model" -->

      var dlBaseUrl = "http://digital-land.github.io"

      var pageSize = 100

      function showLayers() {
        let i = 0;
        mymap.eachLayer(function(layer) {i += 1})
        console.log("layer count", i)
      }

      function buildUrl(bbox_minx, bbox_maxx, bbox_miny, bbox_maxy, after_rowid) {
        return `${baseUrl}/bounded_geography_simplified_paged.json?_json=geojson_simple&_shape=arrayfirst&bbox_minx=${bbox_minx}&bbox_maxx=${bbox_maxx}&bbox_miny=${bbox_miny}&bbox_maxy=${bbox_maxy}&after=${after_rowid}`
      }

      var firstLoad = true

      function fetchFeatures(bbox_minx, bbox_maxx, bbox_miny, bbox_maxy) {
        url = self.buildUrl(bbox_minx, bbox_maxx, bbox_miny, bbox_maxy, 0)
        console.log("fetchFeatures", url)
        firstLoad = true

        var geojson = new L.GeoJSON.AJAX(url, {
          middleware: function(data) {
                  console.log("feature count:", data.length)
                  if (data.length >= pageSize && firstLoad) {
                    console.log("pageSize exceeded, fetching next batch")
                    lastItem = data[data.length-1]
                    console.log("lastItem.rowid", lastItem.id)
                    url = buildUrl(bbox_minx, bbox_maxx, bbox_miny, bbox_maxy, lastItem.id)
                    console.log("continueFetch", url)
                    geojson.addUrl(url)
                    firstLoad = false
                  }
                  return data
          },
          style: function(feature) {
            switch (feature.properties.type) {
                    case 'local-authority-district': return {color: "#EE7800", weight: 2};
                    case 'conservation-area': return {color: "#78AA00", weight: 2};
                    case 'brownfield-land': return {color: "#0078ff", weight: 2};
            }
          },
          onEachFeature: onEachFeature,
        })

        geojson.addTo(myLayer)

        geojson.on('data:loaded', function(data) {
          console.log("data loaded")
          <!-- console.log(data) -->
          <!-- geojson.addTo(myLayer) -->
        })
      }

      mymap.on('moveend', function(event){
        var bounds = event.target.getBounds()
        myLayer.clearLayers()
        fetchFeatures(bounds._southWest.lng, bounds._northEast.lng, bounds._southWest.lat, bounds._northEast.lat)
      });

      var bounds = mymap.getBounds()
      fetchFeatures(bounds._southWest.lng, bounds._northEast.lng, bounds._southWest.lat, bounds._northEast.lat)

    </script>
  </div>
</body>
